################################################################
# Source   : https://www.exploit-db.com/
# Coded By : justakazh
# Github   : https://github.com/justakazh/
#
# Contribute by creating your own source following the guide:
# https://github.com/justakazh/sicat/CONTRIBUTE.md 
################################################################

import requests
import html
import time
from lib.utils import highlight_keyword, ConsoleColors, print_attribute

class Exploitdb:

    def __init__(self):
        ### Result data will be saved here ##
        self.result = []
        self.keyword = None
    
    def WrapperStart(self, silent=False):
        if not silent:
            print("-" * 75)
            print(f"{ConsoleColors.BLUE}[+] Searching in Exploit-DB{ConsoleColors.ENDC}")
            print("-" * 75)
        
    def Output(self, data, limit, silent=False):
        for item in data:
            if limit is not None and len(self.result) >= limit:
                break

            # Safe title extraction
            raw_desc = item.get('description', [])
            if isinstance(raw_desc, list) and len(raw_desc) > 1:
                title = raw_desc[1]
            elif isinstance(raw_desc, str):
                title = raw_desc
            else:
                title = "Unknown"

            source_name = "Exploit-DB"
            source_link = f"https://www.exploit-db.com/exploits/{item['id']}"
            searchBy = "title"

            # Additional fields
            date_published = item.get('date_published', 'Unknown')
            platform = item.get('platform_id', 'Unknown')
            exploit_type = item.get('type_id', 'Unknown')

            wrap = {
                "title" : title,
                "description" : title, # Use title as description since EDb descriptions are titles
                "source_name" : source_name,
                "source_link" : source_link,
                "searchBy" : searchBy,
                "keyword" : self.keyword,
                "platform": platform,
                "type": exploit_type,
                "date": date_published
            }
            
            self.result.append(wrap)

            # Print to console
            if not silent:
                print_attribute("Title", html.unescape(title), self.keyword)
                print_attribute("Link", source_link, self.keyword, no_wrap=True)
                print()

    # parameter builder 
    def _get_base_params(self):
        """Constructs the base parameters required by the Exploit-DB DataTables API."""
        params = {
            "draw": 3,
            "order[0][column]": 0,
            "order[0][dir]": "desc",
            "start": 0,
            "length": 15,
            "search[value]": "",
            "search[regex]": "false",
            "_": int(time.time() * 1000)
        }

        columns = [
            "date_published", "download", "application_md5", "verified", 
            "description", "type_id", "platform_id", "author_id"
        ]

        for i, col in enumerate(columns):
            params[f"columns[{i}][data]"] = col
            params[f"columns[{i}][name]"] = col
            params[f"columns[{i}][search][value]"] = ""
            params[f"columns[{i}][search][regex]"] = "false"
            
            # Set searchable defaults
            # date_published (0), application_md5 (2), verified (3), description (4), type_id (5), platform_id (6) -> true
            # download (1), author_id (7) -> false
            is_searchable = "true" if i not in [1, 7] else "false"
            params[f"columns[{i}][searchable]"] = is_searchable
            
            # Set orderable defaults
            # only date_published (0) is orderable in the original query
            is_orderable = "true" if i == 0 else "false"
            params[f"columns[{i}][orderable]"] = is_orderable

        return params

    def search(self, keyword=None, limit=20, silent=False):
        self.keyword = keyword # Save keyword for highlighting later
        
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3",
            "X-Requested-With": "XMLHttpRequest"
        }

        self.WrapperStart(silent)

        try:
            # Param key mapping: 'q' -> Title/Generic, 'text' -> Content
            search_types = ['q', 'text']
            
            for param_key in search_types:
                if limit is not None and len(self.result) >= limit:
                    break

                start = 0
                while True:
                    if limit is not None and len(self.result) >= limit:
                        break

                    params = self._get_base_params()
                    params[param_key] = keyword
                    params["start"] = start

                    try:
                        resp = requests.get("https://www.exploit-db.com/search", params=params, headers=headers)
                        
                        if resp.status_code == 200:
                            data = resp.json().get('data', [])
                            if not data:
                                break
                            
                            self.Output(data, limit, silent)
                            
                            # If we received fewer items than requested (15), we are at the end
                            if len(data) < 15:
                                break
                        else:
                            break
                    except Exception:
                        break
                    
                    start += 15

            self.wrapperEnd(silent)
            
        except Exception as e:
            print(f"{ConsoleColors.FAIL}[-] Error in Exploit-DB source [search]: {str(e)}{ConsoleColors.ENDC}")

    def wrapperEnd(self, silent=False):
        if silent:
            return
        try:
            if len(self.result) == 0:
                print(f"{ConsoleColors.FAIL}[-] No Exploit Found in Exploit-DB!{ConsoleColors.ENDC}")
            else:
                print(f"{ConsoleColors.BOLD}[*] Total Result : {len(self.result)} Exploits found!{ConsoleColors.ENDC}")
        except Exception as e:
            print(f"{ConsoleColors.FAIL}[-] Error in Exploit-DB source [wrapperEnd]: {str(e)}{ConsoleColors.ENDC}")